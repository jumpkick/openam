#!/bin/bash -ex
. hooks/common

REDIRECT_URI="https://$(unit-get public-address)/secret";

function joined() {
    juju-log "openidc-client-relation-joined on $JUJU_UNIT_NAME invoked $JUJU_REMOTE_UNIT";
    juju-log "REDIRECT_URI:$REDIRECT_URI";
    relation-set redirect_uri="$REDIRECT_URI";
    CLIENT_ID=$(config-get client_id);
    if [ ! -z "$(echo $JUJU_REMOTE_UNIT | grep openam)" ]; then
        CLIENT_ID="OIDCAgent";
    else
        CLIENT_ID=$(config-get client_id);
    fi
   relation-set client_id="$CLIENT_ID";
}

function changed() {
        juju-log "openidc-client-relation-changed on $JUJU_UNIT_NAME invoked $JUJU_REMOTE_UNIT";

        METADATAURL=$(relation-get metadataURL);

        if  [ -z "$METADATAURL" ]; then
            return;
        fi

        CLIENT_ID=$(config-get client_id);
        CLIENT_SECRET=$(config-get client_secret);
        HOSTNAME_PUBLIC=$(unit-get public-address);

        if [ ! -z "$(echo $JUJU_REMOTE_UNIT | grep -i salesforce)" ]; then
                SERVER_ALIAS="salesforce-juju.demo.org"
#               REDIRECT_URI="https://$SERVER_ALIAS/secret";
                echo "$REDIRECT_URI?logout=https://login.salesforce.com/services/oauth2/revoke " > /var/www/oidc/oidc_logout.txt;
#               echo "$REDIRECT_URI?logout=$OPENAM_URL/UI/Logout" > /var/www/oidc/openam_logout.txt;
        fi

        if [ ! -z "$(echo $JUJU_REMOTE_UNIT | grep openam)" ]; then
            CLIENT_ID="OIDCAgent";
            CLIENT_SECRET="secret";
            OPENAM_URL="";
            # Special case for OpenAM as a OIDC provider end EndSession is broken
            OPENAM_URL="$(echo $METADATAURL | cut -d'/' -f1-4)";
            echo "$REDIRECT_URI?logout=$OPENAM_URL" > /var/www/oidc/oidc_logout.txt;
            echo "$REDIRECT_URI?logout=$OPENAM_URL/UI/Logout" > /var/www/oidc/openam_logout.txt;
        fi

        juju-log "$CLIENT_ID='$CLIENT_ID', CLIENT_SECRET='$CLIENT_SECRET', METADATAURL='$METADATAURL'";

# OpenAM need to add "profile" to the OpenAM scope, not needed for Salesforce...

cat << EOF > $OIDC_CONF_FILE;
<VirtualHost *:443>
SSLEngine on
SSLCertificateFile $SSL_CERT_FILE
SSLCertificateKeyFile $SSL_KEY_FILE

#Session On
#SessionCookieName session path=/

ServerName $HOSTNAME_PUBLIC

ErrorLog /var/log/apache2/oidc-error_log
CustomLog /var/log/apache2/oidc-access_log common
DocumentRoot $DOCROOT

LogLevel trace8
OIDCCookiePath /oidc/
OIDCSSLValidateServer Off
OIDCOAuthSSLValidateServer Off
OIDCCryptoPassphrase password2
#OIDCScope "openid email profile"
OIDCScope "openid"

#
# Discovery
#
OIDCProviderMetadataURL $METADATAURL
OIDCClientID $CLIENT_ID
OIDCClientSecret $CLIENT_SECRET
OIDCRedirectURI $REDIRECT_URI
OIDCCryptoPassphrase password2
#
# Using explicite endpoints
#
#OIDCProviderIssuer $OPENAM_URL
#OIDCProviderAuthorizationEndpoint $OPENAM_URL/oauth2/authorize
#OIDCProviderTokenEndpoint $OPENAM_URL/oauth2/access_token
#OIDCProviderTokenEndpointAuth client_secret_post
#OIDCProviderUserInfoEndpoint $OPENAM_URL/oauth2/userinfo
#OIDCClientID OIDCAgent
#OIDCClientSecret $CLIENT_SECRET
#OIDCDiscoverURL $OPENAM_URL/.well-known/openid-configuration
#OIDCRedirectURI $REDIRECT_URI
#
# Default endSession endpoint currently broken in OpenAM as of 31.Oct.2014 
#OIDCProviderEndSessionEndpoint $OPENAM_URL/oauth2/connect/endSession

<Location />
    DirectoryIndex index.php
    Authtype openid-connect
    require valid-user
</Location>
</VirtualHost>
EOF

    # Restart Apache HTTPD deamon
    a2dissite default;
    a2enmod auth_openidc;
    a2ensite oidc;
    service apache2 restart;
    open-port 443;
    close-port 80;
    juju-log "done."
}

function departed() {
	juju-log "openidc-client-relation-departed on $JUJU_UNIT_NAME invoked $JUJU_REMOTE_UNIT";
    relation-set CLIENT_ID="$CLIENT_ID";
}

function broken() {
	juju-log "openidc-client-relation-broken on $JUJU_UNIT_NAME invoked $JUJU_REMOTE_UNIT";
    # Enabling the new default initial config
    a2dissite oidc;
    a2dismod auth_openidc;
    a2ensite default;
    close-port 443;
    open-port 80;
    service apache2 restart;
}

cmd=$(basename "$0");
juju-log "CMD:$cmd:";
case "$cmd" in
	openidc-client-relation-changed)
        changed;
        ;;
	openidc-client-relation-departed)
        departed;
        ;;
    openidc-client-relation-joined)
		joined;
	;;
	openidc-client-relation-broken)
		broken;
	;;
esac
